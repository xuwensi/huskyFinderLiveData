{"ast":null,"code":"'use strict';\n\nvar U = module.exports;\n\nvar Keypairs = require('@root/keypairs');\n\nvar UserAgent = require('./lib/node/client-user-agent.js'); // Handle nonce, signing, and request altogether\n\n\nU._jwsRequest = function (me, bigopts) {\n  return U._getNonce(me).then(function (nonce) {\n    bigopts.protected.nonce = nonce;\n    bigopts.protected.url = bigopts.url; // protected.alg: added by Keypairs.signJws\n\n    if (!bigopts.protected.jwk) {\n      // protected.kid must be overwritten due to ACME's interpretation of the spec\n      if (!('kid' in bigopts.protected)) {\n        bigopts.protected.kid = bigopts.kid;\n      }\n    } // this will shasum the thumbprint the 2nd time\n\n\n    return Keypairs.signJws({\n      jwk: bigopts.accountKey,\n      protected: bigopts.protected,\n      payload: bigopts.payload\n    }).then(function (jws) {\n      //#console.debug('[ACME.js] url: ' + bigopts.url + ':');\n      //#console.debug(jws);\n      return U._request(me, {\n        url: bigopts.url,\n        json: jws\n      });\n    }).catch(function (e) {\n      if (/badNonce$/.test(e.urn)) {\n        // retry badNonces\n        var retryable = bigopts._retries >= 2;\n\n        if (!retryable) {\n          bigopts._retries = (bigopts._retries || 0) + 1;\n          return U._jwsRequest(me, bigopts);\n        }\n      }\n\n      throw e;\n    });\n  });\n};\n\nU._getNonce = function (me) {\n  var nonce;\n\n  while (true) {\n    nonce = me._nonces.shift();\n\n    if (!nonce) {\n      break;\n    }\n\n    if (Date.now() - nonce.createdAt > 15 * 60 * 1000) {\n      nonce = null;\n    } else {\n      break;\n    }\n  }\n\n  if (nonce) {\n    return Promise.resolve(nonce.nonce);\n  } // HEAD-as-HEAD ok\n\n\n  return U._request(me, {\n    method: 'HEAD',\n    url: me._directoryUrls.newNonce\n  }).then(function (resp) {\n    return resp.headers['replay-nonce'];\n  });\n}; // Handle some ACME-specific defaults\n\n\nU._request = function (me, opts) {\n  // no-op on browser\n  var ua = UserAgent.get(me, opts); // Note: the required User-Agent string will be set in node, but not browsers\n\n  if (!opts.headers) {\n    opts.headers = {};\n  }\n\n  if (ua && !opts.headers['User-Agent']) {\n    opts.headers['User-Agent'] = ua;\n  }\n\n  if (opts.json) {\n    opts.headers.Accept = 'application/json';\n\n    if (true !== opts.json) {\n      opts.body = JSON.stringify(opts.json);\n    }\n\n    if (\n    /*opts.jose ||*/\n    opts.json.protected) {\n      opts.headers['Content-Type'] = 'application/jose+json';\n    }\n  }\n\n  if (!opts.method) {\n    opts.method = 'GET';\n\n    if (opts.body) {\n      opts.method = 'POST';\n    }\n  } //console.log('\\n[debug] REQUEST');\n  //console.log(opts);\n\n\n  return me.__request(opts).then(function (resp) {\n    if (resp.toJSON) {\n      resp = resp.toJSON();\n    }\n\n    if (resp.headers['replay-nonce']) {\n      U._setNonce(me, resp.headers['replay-nonce']);\n    } //console.log('[debug] RESPONSE:');\n    //console.log(resp.headers);\n    //console.log(resp.body);\n\n\n    var e;\n    var err;\n\n    if (resp.body) {\n      err = resp.body.error;\n      e = new Error('');\n\n      if (400 === resp.body.status) {\n        err = {\n          type: resp.body.type,\n          detail: resp.body.detail\n        };\n      }\n\n      if (err) {\n        e.status = resp.body.status;\n        e.code = 'E_ACME';\n\n        if (e.status) {\n          e.message = '[' + e.status + '] ';\n        }\n\n        e.detail = err.detail;\n        e.message += err.detail || JSON.stringify(err);\n        e.urn = err.type;\n        e.uri = resp.body.url;\n        e._rawError = err;\n        e._rawBody = resp.body;\n        throw e;\n      }\n    }\n\n    return resp;\n  });\n};\n\nU._setNonce = function (me, nonce) {\n  me._nonces.unshift({\n    nonce: nonce,\n    createdAt: Date.now()\n  });\n};\n\nU._importKeypair = function (key) {\n  var p;\n  var pub;\n\n  if (key && key.kty) {\n    // nix the browser jwk extras\n    key.key_ops = undefined;\n    key.ext = undefined;\n    pub = Keypairs.neuter({\n      jwk: key\n    });\n    p = Promise.resolve({\n      private: key,\n      public: pub\n    });\n  } else if ('string' === typeof key) {\n    p = Keypairs.import({\n      pem: key\n    });\n  } else {\n    throw new Error('no private key given');\n  }\n\n  return p.then(function (pair) {\n    if (pair.public.kid) {\n      pair = JSON.parse(JSON.stringify(pair));\n      delete pair.public.kid;\n      delete pair.private.kid;\n    }\n\n    return pair;\n  });\n};","map":{"version":3,"sources":["C:/Users/xuwen/Desktop/INFO340/project-2-xuwensi/node_modules/@root/acme/utils.js"],"names":["U","module","exports","Keypairs","require","UserAgent","_jwsRequest","me","bigopts","_getNonce","then","nonce","protected","url","jwk","kid","signJws","accountKey","payload","jws","_request","json","catch","e","test","urn","retryable","_retries","_nonces","shift","Date","now","createdAt","Promise","resolve","method","_directoryUrls","newNonce","resp","headers","opts","ua","get","Accept","body","JSON","stringify","__request","toJSON","_setNonce","err","error","Error","status","type","detail","code","message","uri","_rawError","_rawBody","unshift","_importKeypair","key","p","pub","kty","key_ops","undefined","ext","neuter","private","public","import","pem","pair","parse"],"mappings":"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","sourcesContent":["'use strict';\n\nvar U = module.exports;\n\nvar Keypairs = require('@root/keypairs');\nvar UserAgent = require('./lib/node/client-user-agent.js');\n\n// Handle nonce, signing, and request altogether\nU._jwsRequest = function(me, bigopts) {\n\treturn U._getNonce(me).then(function(nonce) {\n\t\tbigopts.protected.nonce = nonce;\n\t\tbigopts.protected.url = bigopts.url;\n\t\t// protected.alg: added by Keypairs.signJws\n\t\tif (!bigopts.protected.jwk) {\n\t\t\t// protected.kid must be overwritten due to ACME's interpretation of the spec\n\t\t\tif (!('kid' in bigopts.protected)) {\n\t\t\t\tbigopts.protected.kid = bigopts.kid;\n\t\t\t}\n\t\t}\n\n\t\t// this will shasum the thumbprint the 2nd time\n\t\treturn Keypairs.signJws({\n\t\t\tjwk: bigopts.accountKey,\n\t\t\tprotected: bigopts.protected,\n\t\t\tpayload: bigopts.payload\n\t\t})\n\t\t\t.then(function(jws) {\n\t\t\t\t//#console.debug('[ACME.js] url: ' + bigopts.url + ':');\n\t\t\t\t//#console.debug(jws);\n\t\t\t\treturn U._request(me, { url: bigopts.url, json: jws });\n\t\t\t})\n\t\t\t.catch(function(e) {\n\t\t\t\tif (/badNonce$/.test(e.urn)) {\n\t\t\t\t\t// retry badNonces\n\t\t\t\t\tvar retryable = bigopts._retries >= 2;\n\t\t\t\t\tif (!retryable) {\n\t\t\t\t\t\tbigopts._retries = (bigopts._retries || 0) + 1;\n\t\t\t\t\t\treturn U._jwsRequest(me, bigopts);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthrow e;\n\t\t\t});\n\t});\n};\n\nU._getNonce = function(me) {\n\tvar nonce;\n\twhile (true) {\n\t\tnonce = me._nonces.shift();\n\t\tif (!nonce) {\n\t\t\tbreak;\n\t\t}\n\t\tif (Date.now() - nonce.createdAt > 15 * 60 * 1000) {\n\t\t\tnonce = null;\n\t\t} else {\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (nonce) {\n\t\treturn Promise.resolve(nonce.nonce);\n\t}\n\n\t// HEAD-as-HEAD ok\n\treturn U._request(me, {\n\t\tmethod: 'HEAD',\n\t\turl: me._directoryUrls.newNonce\n\t}).then(function(resp) {\n\t\treturn resp.headers['replay-nonce'];\n\t});\n};\n\n// Handle some ACME-specific defaults\nU._request = function(me, opts) {\n\t// no-op on browser\n\tvar ua = UserAgent.get(me, opts);\n\n\t// Note: the required User-Agent string will be set in node, but not browsers\n\tif (!opts.headers) {\n\t\topts.headers = {};\n\t}\n\n\tif (ua && !opts.headers['User-Agent']) {\n\t\topts.headers['User-Agent'] = ua;\n\t}\n\tif (opts.json) {\n\t\topts.headers.Accept = 'application/json';\n\t\tif (true !== opts.json) {\n\t\t\topts.body = JSON.stringify(opts.json);\n\t\t}\n\t\tif (/*opts.jose ||*/ opts.json.protected) {\n\t\t\topts.headers['Content-Type'] = 'application/jose+json';\n\t\t}\n\t}\n\tif (!opts.method) {\n\t\topts.method = 'GET';\n\t\tif (opts.body) {\n\t\t\topts.method = 'POST';\n\t\t}\n\t}\n\n\t//console.log('\\n[debug] REQUEST');\n\t//console.log(opts);\n\treturn me.__request(opts).then(function(resp) {\n\t\tif (resp.toJSON) {\n\t\t\tresp = resp.toJSON();\n\t\t}\n\t\tif (resp.headers['replay-nonce']) {\n\t\t\tU._setNonce(me, resp.headers['replay-nonce']);\n\t\t}\n\t\t//console.log('[debug] RESPONSE:');\n\t\t//console.log(resp.headers);\n\t\t//console.log(resp.body);\n\n\t\tvar e;\n\t\tvar err;\n\t\tif (resp.body) {\n\t\t\terr = resp.body.error;\n\t\t\te = new Error('');\n\t\t\tif (400 === resp.body.status) {\n\t\t\t\terr = { type: resp.body.type, detail: resp.body.detail };\n\t\t\t}\n\t\t\tif (err) {\n\t\t\t\te.status = resp.body.status;\n\t\t\t\te.code = 'E_ACME';\n\t\t\t\tif (e.status) {\n\t\t\t\t\te.message = '[' + e.status + '] ';\n\t\t\t\t}\n\t\t\t\te.detail = err.detail;\n\t\t\t\te.message += err.detail || JSON.stringify(err);\n\t\t\t\te.urn = err.type;\n\t\t\t\te.uri = resp.body.url;\n\t\t\t\te._rawError = err;\n\t\t\t\te._rawBody = resp.body;\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\n\t\treturn resp;\n\t});\n};\n\nU._setNonce = function(me, nonce) {\n\tme._nonces.unshift({ nonce: nonce, createdAt: Date.now() });\n};\n\nU._importKeypair = function(key) {\n\tvar p;\n\tvar pub;\n\n\tif (key && key.kty) {\n\t\t// nix the browser jwk extras\n\t\tkey.key_ops = undefined;\n\t\tkey.ext = undefined;\n\t\tpub = Keypairs.neuter({ jwk: key });\n\t\tp = Promise.resolve({\n\t\t\tprivate: key,\n\t\t\tpublic: pub\n\t\t});\n\t} else if ('string' === typeof key) {\n\t\tp = Keypairs.import({ pem: key });\n\t} else {\n\t\tthrow new Error('no private key given');\n\t}\n\n\treturn p.then(function(pair) {\n\t\tif (pair.public.kid) {\n\t\t\tpair = JSON.parse(JSON.stringify(pair));\n\t\t\tdelete pair.public.kid;\n\t\t\tdelete pair.private.kid;\n\t\t}\n\t\treturn pair;\n\t});\n};\n"]},"metadata":{},"sourceType":"script"}